
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Essential C# 4.0: Advanced - Puncsky CS Notebook</title>
  <meta name="author" content="Tian">

  
  <meta name="description" content="Life and computer science notebook from Puncsky">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.puncsky.com/blog/2013/09/15/essential-c-sharp-advanced">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/bootstrap/bootstrap.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/stylesheets/bootstrap/responsive.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/stylesheets/syntax/syntax.css" media="screen, projection" rel="stylesheet" type="text/css">
  <style type="text/css">
    body {
      padding-bottom: 40px;
    }
    h1 {
      margin-bottom: 15px;
    }
    img {
      max-width: 100%;
    }
    .sharing, .meta, .pager {
      margin: 20px 0px 20px 0px;
    }
    .page-footer p {
      text-align: center;
    }
  </style>
  <script src="/javascripts/libs/jquery.js"></script>
  <script src="/javascripts/libs/modernizr-2.0.js"></script>
  <script src="/javascripts/libs/bootstrap.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Puncsky CS Notebook" type="application/atom+xml">
  <link href="http://fonts.googleapis.com/css?family=Ubuntu:300,400,500,700,300italic,400italic,500italic,700italic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,500italic,700italic,300,400,500,700,800" rel="stylesheet" type="text/css">
<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js">
  MathJax.Hub.Config({
   extensions: ["tex2jax.js","TeX/AMSmath.js","TeX/AMSsymbols.js"],
   jax: ["input/TeX", "output/HTML-CSS"],
   tex2jax: {
       inlineMath: [ ['$','$'], ["\\(","\\)"] ],
       displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
   },
   "HTML-CSS": { availableFonts: ["TeX"] }
  });
</script>

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-43072488-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <nav role="navigation"><div class="navbar navbar-inverse">
  <div class="navbar-inner">
    <div class="container">
      <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </a>

      <a class="brand" href="/">Puncsky CS Notebook</a>

      <div class="nav-collapse">
        <ul class="nav">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/notes">Notes</a></li>
</ul>


        <ul class="nav pull-right" data-subscription="rss">
          <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
          
        </ul>

        
          <form class="pull-right navbar-search" action="http://google.com/search" method="get">
            <fieldset role="search">
              <input type="hidden" name="q" value="site:www.puncsky.com" />
              <input class="search-query" type="text" name="q" results="0" placeholder="Search"/>
            </fieldset>
          </form>
        
      </div>
    </div>
  </div>
</div>
</nav>
  <div class="container">
    <div class="row-fluid">
      
<article class="hentry span9" role="article">

  
  <header class="page-header">
    
      <h1 class="entry-title">Essential C# 4.0: Advanced</h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-09-15T13:58:00-07:00" pubdate data-updated="true">Sep 15<span>th</span>, 2013</time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>This is the third and final part of my series of notes on learning C#.</p>

<ol>
<li><a href="http://www.puncsky.com/blog/2013/08/14/essential-c-sharp-basics/">Essential C# 4.0: Basics</a></li>
<li><a href="http://www.puncsky.com/blog/2013/09/05/essential-c-sharp-intermediate/">Essential C# 4.0: Intermediate</a></li>
<li>Essential C# 4.0: Advanced(this post)</li>
</ol>


<p>In general, C# leaves me an unpleasant impression of redundancy and tyranny. The designers of the language seem to be always mocking &#8220;oh my stupid boy, we have to spare no effort to prevent you from making stupid mistakes~&#8221; However, this idea of design is <em>good</em> to some extend.</p>

<p>My passion on coding is mostly inspired by the colorful vim on Ubuntu. <em>It is amazing fun. I love it!!</em> So the first app I install on my new Windows workstation is, of course, cygwin. Now I have to use Visual Studio, so the first plugin I install on it is surely vsvim. Moreover, maybe I am not a guy of Eclipse. I can see no beauty and usability in it, although it is much more extensible than Visual Studio. The experience of configuring the build environment of Android and later Hadoop is awful and drives me crazy.</p>

<p>As to the last chapters of this book, I am not interested in muti-processing/multi-threading in Windows OS, which is much slower than *nix OS and thus somewhat boring. Windows was not designed to be a multiprocessing and multi-user platform in the first place; instead, it was originally intended for <em>personal</em> usage. So I just skimmed this chapter. Maybe I will revisit it someday when I have to exhaust the computing power on Windows. May that not happen.</p>

<p>At last, C# is not designed for manipulating pointers and addresses directly. Why do we bother to study it? We have C/C++ already. So I also just skimmed the last two chapters. :D</p>

<p>The following is my notes.</p>

<!--more-->


<h2>14 Collection Interfaces with Standard Query Operators 535</h2>

<ol>
<li>Anonymous Types

<ul>
<li><code>var patent = new {Title = "Bifocals", YearOfPublication = "1784"}</code></li>
</ul>
</li>
<li>Implicit Typed Local Variables (<code>var</code>)

<ul>
<li>There is no difference in the resultant CIL code for implic- itly typed variables whose assignment is not an anonymous type (such as string) and those that are declared as type string.</li>
<li><strong><em>still strongly typed as well by the compiler.</em></strong>

<ul>
<li><em>Language Contrast</em>: JavaScript&#8217;s var is dynamically typed. <a href="http://stackoverflow.com/questions/8457813/difference-between-the-implementation-of-var-in-javascript-and-c-sharp">See here</a>. C# is (usually) a statically typed language.</li>
</ul>
</li>
<li>You should use implicitly typed variable declarations sparingly

<ul>
<li>To accomplish this with implicitly typed local variables, use them only when the type assigned to the implicitly typed variable is entirely obvious and makes themselves more readable.</li>
<li>e.g. <code>var items = new Dictionary&lt;string, List&lt;Account&gt;&gt;();</code></li>
<li>e.g. <code>Dictionary&lt;string, List&lt;Account&gt;&gt; dictionary = GetAccounts();</code></li>
<li>the requirements for two anonymous types to be type-compatible within the same assembly are a match in property names, data types, and order of properties.</li>
</ul>
</li>
</ul>
</li>
<li>Collection Initializers</li>
<li>Collections

<ul>
<li>Arrays(length fixed, index operator supported)

<ul>
<li><code>foreach(TItem item in array) {}</code></li>
</ul>
</li>
<li>IEnumerable<T> (such as <code>Stack&lt;T&gt;</code>, <code>Queue&lt;T&gt;</code>, <code>Dictionary&lt;Tkey, Tvalue&gt;</code>)

<ul>
<li><code>while (stack.MoveNext()) {number = stack.Current; Console.WriteLine(number)}</code></li>
<li><strong>The state of moving to the next is shared.</strong> So we need <code>Enumerator</code> and <code>GetEnumerator()</code></li>
<li><code>Dispose()</code> the enumerator&#8217;s state. A more simplified version in the example.</li>
</ul>
</li>
<li><code>foreach</code> without <code>IEnumerable</code>?

<ul>
<li>&#8220;duck typing&#8221;: if no IEnumerable/IEnumerable<T> method is found, it looks for the <code>GetEnumerator()</code> method to return a type with Current() and MoveNext() methods. Duck typing involves searching for a method by name rather than relying on an interface or explicit method call to the method.</li>
</ul>
</li>
<li><strong><em>compiler prevents assignment of the foreach variable</em></strong> Do not modify the collection during a foreach loop.</li>
</ul>
</li>
<li><strong>Standard Query Operators</strong>

<ul>
<li>Each method on <code>IEnumerable&lt;T&gt;</code> is a standard query operator</li>
<li>Filtering with <code>Where()</code>

<ul>
<li>A delegate expression that takes an argument and returns a Boolean is called a <strong>predicate</strong></li>
</ul>
</li>
<li>Projecting with <code>Select()</code>

<ul>
<li><code>IEnumerable&lt;FileInfo&gt; files = fileList.Select(file =&gt; new FileInfo(file))</code></li>
<li>PLINQ(Parallel LINQ): <code>.AsParallel().</code> See CH18, CH19</li>
</ul>
</li>
<li>Counting with <code>Count()</code></li>
<li><strong><em>Deferring Execution</em></strong>: One of the most important concepts to remember when using LINQ

<ul>
<li>At the time of declaration(&#8220;.Where()&#8221;), lambda expressions do not execute. It isn’t until the lambda expressions are invoked (<code>foreach</code>) that the code within them begins to execute.</li>
<li><strong>To avoid such repeated execution, it is necessary to cache the data that the executed query retrieves.</strong> To do this, you assign the data to a local collection using one of the “To” method’s collection methods.</li>
</ul>
</li>
<li>Sorting with <code>OrderBy()</code> and <code>OrderBy().ThenBy()</code>

<ul>
<li>return a <code>IOrderedEnumerable&lt;T&gt;</code> instead of <code>IEnumerable&lt;T&gt;</code></li>
</ul>
</li>
<li><code>IEnumerable&lt;IGrouping&lt;int, Employee&gt;&gt; groupedEmployees = employees.GroupBy((employee) =&gt; employee.DepartmentId);</code></li>
<li><code>GroupJoin()</code>, <code>SelectMany()</code>&#8230;</li>
</ul>
</li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="k">using</span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="n">Collections</span><span class="p">.</span><span class="n">Generic</span><span class="p">.</span><span class="n">Stack</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">.</span><span class="n">Enumerator</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="n">enumerator</span> <span class="o">=</span> <span class="n">stack</span><span class="p">.</span><span class="n">GetEnumerator</span><span class="p">())</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span><span class="n">enumerator</span><span class="p">.</span><span class="n">MoveNext</span><span class="p">())</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">number</span> <span class="o">=</span> <span class="n">enumerator</span><span class="p">.</span><span class="n">Current</span><span class="p">;</span>
</span><span class='line'>      <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">number</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>15 LINQ with Query Expressions 589</h2>

<ul>
<li><strong>More readable and SQL-like query expressions</strong>, when compared to Standard Query Operators</li>
</ul>


<h2>16 Building Custom Collections 611</h2>

<ol>
<li>More Collection Interfaces

<ul>
<li><code>IList&lt;T&gt;</code></li>
<li><code>IDictionary&lt;TKey, TValue&gt;</code></li>
<li><code>IComparable&lt;T&gt;</code></li>
<li><code>ICollection&lt;T&gt;</code></li>
</ul>
</li>
<li>Primary Collection Classes

<ul>
<li><code>List&lt;T&gt;</code></li>
<li><code>Dictionary&lt;TKey, TValue&gt;</code></li>
<li><code>SortedDictionary&lt;TKey, TValue&gt;</code> and <code>SortedList&lt;T&gt;</code></li>
<li><code>Stack&lt;T&gt;</code></li>
<li><code>Queue&lt;T&gt;</code></li>
<li><code>LinkedList&lt;T&gt;</code></li>
</ul>
</li>
<li>Providing an Index Operator <code>[]</code>

<ul>
<li><code>public T1 this[T2 index] {}</code> and <code>public T this[params PairItem[] branches] {}</code></li>
</ul>
</li>
<li>Returning null or an Empty Collection

<ul>
<li>The better choice in general is to return a collection instance with no items.</li>
<li>One of the few times to deviate from this guideline is when <code>null</code> is intentionally indicating something different from zero items. e.g. telephone number, <code>null</code> for not set, empty for no phone number</li>
</ul>
</li>
<li>Iterators, <code>IEnumerator&lt;T&gt;</code> and <code>IEnumerator</code>

<ul>
<li>If classes want to support iteration using the foreach loop construct, they must implement the enumerator pattern.</li>
<li>Defining</li>
<li>Syntax

<ol>
<li>the class should derive from <code>IEnumerable&lt;T&gt;</code></li>
<li><code>public IEnumerator&lt;T&gt; GetEnumerator() {}</code> method</li>
</ol>
</li>
<li><strong><em>yield</em></strong>

<ul>
<li>Iterators are like functions, but instead of returning values, they yield them. 生成一个个即将被iterate 的结果？</li>
<li><code>yield return SomeObject;</code> you can use yield only in <code>GetEnumerator()</code> methods that return <code>IEnumerator&lt;T&gt;</code>, or in methods that return <code>IEnumerable&lt;T&gt;</code> but are not called GetEnumerator().

<ul>
<li>C# compiler generates the code to maintain the state machine for the iterator.</li>
</ul>
</li>
<li><code>yield break;</code></li>
<li>some other restrictions: P649</li>
</ul>
</li>
</ul>
</li>
</ol>


<h2>17 Reflection, Attributes, and Dynamic Programming 651</h2>

<p><strong>Reflection</strong> is the process of examining the metadata within an assembly.</p>

<ol>
<li>Accessing Metadata Using <code>System.Type</code>

<ul>
<li><code>GetType()</code></li>
<li><code>typeof()</code></li>
</ul>
</li>
<li>Member Invocation

<ul>
<li><code>type.GetProperty()</code> and <code>property.SetValue()</code> see examples</li>
</ul>
</li>
<li>Reflection on Generics

<ul>
<li><code>type.IsGenericType</code></li>
<li><code>foreach(Type type in t.GetGenericArguments()) {}</code></li>
</ul>
</li>
<li>Custom Attributes

<ul>
<li>attributes are a means of associating additional data with a property (and other constructs).</li>
<li><em>Language Contrast</em>: Attributes are to C# what annotations are to Java</li>
<li>2 ways to combine

<ol>
<li><code>[Attr1] [Attr2]</code></li>
<li><code>[Attr1, Attr2]</code></li>
</ol>
</li>
<li>custom attributes

<ul>
<li><code>public class CLISwitchRequiredAttribute : Attribute {}</code></li>
</ul>
</li>
<li>get custom attributes

<ul>
<li><code>Attribute[] a = (Attribute[])property.GetCustomAttributes(...)</code></li>
</ul>
</li>
</ul>
</li>
<li>Attribute Constructors

<ul>
<li><code>public class CLISwitchRequiredAttribute : Attribute { CLISwitchAliasAttribute(string alias) {Alias = alias;}}</code></li>
</ul>
</li>
<li>Named Parameters</li>
<li>Predefined Attributes

<ul>
<li><code>AttributeUsageAttribute</code> before the attribute class to set target properties</li>
<li><code>ConditionalAttribute("CONDITION_BLAH")</code> before the methods to call on condition of <code>#define CONDITION_BLAH</code></li>
<li><code>ObsoleteAttribute</code> causes a compile-time warning, optionally an error.</li>
<li><code>Serializable</code> before class for storage

<ul>
<li><code>NonSerializable</code></li>
<li>version problem? <code>System.Runtime.Serialization.OptionalFieldAttribute</code></li>
</ul>
</li>
</ul>
</li>
<li>Dynamic Objects

<ul>
<li>Dynamic object support provides a common solution for talking to runtime environments that don’t necessarily have a compile-time-defined structure.</li>
<li>The key difference when using a dynamic object is that it is necessary to identify the signature at compile time, rather than determine things such as the member name at runtime (like we did when parsing the command-line arguments).</li>
<li>TODO</li>
</ul>
</li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="c1">// Using Type.GetProperties() to Obtain an Object&#39;s Public Properties</span>
</span><span class='line'><span class="n">DateTime</span> <span class="n">dateTime</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DateTime</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="n">Type</span> <span class="n">type</span> <span class="o">=</span> <span class="n">dateTime</span><span class="p">.</span><span class="n">GetType</span><span class="p">();</span>
</span><span class='line'><span class="n">foreach</span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="n">Reflection</span><span class="p">.</span><span class="n">PropertyInfo</span> <span class="n">property</span> <span class="n">in</span> <span class="n">type</span><span class="p">.</span><span class="n">GetProperties</span><span class="p">())</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">property</span><span class="p">.</span><span class="n">Name</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>18 Multithreading 701</h2>

<p>thread, time slicing.</p>

<p>In .NET Framework 4, the task requests a thread from the thread pool.</p>

<ul>
<li><p><code>Task</code> in <strong>Task Parallel Library</strong></p>

<ul>
<li><code>class Task(Delegate Func);</code> and <code>class Task&lt;TResult&gt;(Delegate Func)</code></li>
<li><code>task.Result</code>, <code>task.IsCompleted</code>, <code>task.Id</code>, <code>task.AsyncState</code>, static <code>Task.CurrentId</code>,</li>
</ul>
</li>
<li><p>Parallel Loops</p>

<ul>
<li><code>Parallel.For()</code></li>
<li><code>Parallel.ForEach&lt;T&gt;()</code></li>
</ul>
</li>
<li>Unhanded Exceptions</li>
<li><strong>Parallel LINQ</strong></li>
<li>Multithreaded Programming with Tasks

<ul>
<li>Task Basiscs</li>
<li><code>ContinueWith()</code></li>
<li>Unhandled Exceptions</li>
</ul>
</li>
<li>TPL Cancellation Requests

<ul>
<li>Canceling a Task</li>
<li>Canceling Parallel Loops</li>
<li>Canceling a Task</li>
</ul>
</li>
<li><del>Multithreaded Programming before TPL (Before .NET 4)</del></li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="c1">// Task</span>
</span><span class='line'><span class="k">using</span> <span class="n">System</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="n">System</span><span class="p">.</span><span class="n">Threading</span><span class="p">.</span><span class="n">Tasks</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">Program</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">static</span> <span class="kt">void</span> <span class="n">Main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">const</span> <span class="kt">int</span> <span class="n">repetitions</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">;</span>
</span><span class='line'>    <span class="n">Task</span> <span class="n">task</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Task</span><span class="p">(</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="n">repetitions</span><span class="p">;</span> <span class="n">count</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="n">Console</span><span class="p">.</span><span class="n">Write</span><span class="p">(</span><span class="sc">&#39;-&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">task</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="n">repetitions</span><span class="p">;</span> <span class="n">count</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">Console</span><span class="p">.</span><span class="n">Write</span><span class="p">(</span><span class="sc">&#39;.&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Wait until the Task completes</span>
</span><span class='line'>    <span class="n">task</span><span class="p">.</span><span class="n">Wait</span><span class="p">();</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>19 Multithreading Patterns 749</h2>

<ul>
<li><p>Thread-safe: Code or dada synchronized for simultaneous access by multiple threads.</p></li>
<li><p><a href="http://msdn.microsoft.com/en-us/library/ff963559.aspx">torn read</a>. When reading a variable requires more than one machine instruction, and another task writes to the variable between the read instructions.</p></li>
<li><p>Local variables are loaded onto the stack and each thread has its own logical stack. (But they can still be accessed by other threads.)</p></li>
<li><p>Synchronization</p>

<ul>
<li>Monitor

<ul>
<li>use a monitor to block the second thread from entering a protected code section before the first thread has exited that section. See the example.</li>
<li><code>_Sync</code> object, <code>try</code>/<code>finally</code></li>
</ul>
</li>
<li>Lock

<ul>
<li>Monitor is fallible with <code>try</code>/<code>finally</code> (forgettable)</li>
<li>use a per-synchronization context instance of type object for the lock target.</li>
<li>avoid locking <code>this</code>, <code>typeof(type)</code>, and <code>string</code>  TODO:??我的理解是不要从instance内部锁，一律从外部锁，防止死锁。</li>
</ul>
</li>
<li><p>Volatile <em>Language Contrast</em>:</p>

<ul>
<li>C#: ensures that code accessing the field is not subject to some thread unsafe optimizations that may be performed by the compiler, the CLR, or by hardware. (forces all reads and writes to the volatile field to occur at the exact location the code identifies instead of at some other location that the) optimization produces.</li>
<li>Java: read its current value before continuing, instead of (potentially) using a cached value. Volatile reads and writes establish a happens-before relationship, much like acquiring and releasing a mutex.</li>
<li>C: volatile exists for specifying special treatment for such locations, specifically: (1) the content of a volatile variable is &#8220;unstable&#8221; (can change by means unknown to the compiler), (2) all writes to volatile data are &#8220;observable&#8221; so they must be executed religiously, and (3) all operations on volatile data are executed in the sequence in which they appear in the source code.

<ul>
<li>usage of volatile keyword as a portable synchronization mechanism <strong>is discouraged</strong> by many C/C++ groups.</li>
</ul>
</li>
</ul>
</li>
<li><p><code>System.Threading.Interlocked</code></p>

<ul>
<li>synchronization with System.Threading.Monitor is a relatively expensive operation</li>
<li>If <code>_Data</code> is <code>null</code> then set it to <code>newValue</code>

<ul>
<li><code>Interlocked.CompareExchange(ref _data, newValue, null);</code></li>
</ul>
</li>
</ul>
</li>
<li>Synchronization Best Practices

<ul>
<li>avoid deadlocks. Deadlock&#8217;s 4 conditions:

<ol>
<li>Mutual exclusion</li>
<li>Hold and wait</li>
<li>No preemption</li>
<li>Circular wait condition</li>
</ol>
</li>
<li>All static data should be thread-safe.

<ul>
<li>programmers should declare private static variables and then provide public methods for modifying the data. Such methods should internally handle the synchronization.</li>
</ul>
</li>
</ul>
</li>
<li><code>Mutex</code></li>
<li>WaitHandle</li>
<li>Reset Events

<ul>
<li> reset events have nothing to do with C# delegates and events. Instead, reset events are a way to <strong>force code to wait for the execution of another thread until the other thread signals</strong></li>
<li>Favor <code>ManualResetEvent</code> and <code>Semaphores</code> over <code>AutoResetEvent</code></li>
</ul>
</li>
<li>Concurrent Collection Classes

<ul>
<li>designed to include built-in synchronization code so that they can support simultaneous access by multiple threads without concern for race conditions.</li>
<li><code>BlockingCollection&lt;T&gt;</code></li>
<li><code>ConcurrentBag&lt;T&gt;</code></li>
<li><code>ConcurrentDictionary&lt;TKey, TValue&gt;</code></li>
<li><code>ConcurrentQueue&lt;T&gt;</code></li>
<li><code>ConcurrentStack&lt;T&gt;</code></li>
</ul>
</li>
</ul>
</li>
<li>Thread Local Storage

<ul>
<li><code>ThreadLocal&lt;T&gt;</code></li>
<li><code>ThreadStaticAttribute</code></li>
</ul>
</li>
<li>Timers</li>
<li>Asynchronous Programming Model (APM)

<ul>
<li>the key aspect of the APM is the pair of <code>IAsyncResult BeginX()</code> and <code>EndX()</code> methods with well-established signatures.</li>
<li><code>WaitHandle</code> to determine when the asynchronous method completes.</li>
<li><code>EndX()</code>

<ol>
<li>block further execution until the successful complete</li>
<li>get the return data</li>
<li>receive the exception</li>
<li>clean up resources</li>
</ol>
</li>
</ul>
</li>
<li>Background Worker Pattern

<ul>
<li>TODO</li>
</ul>
</li>
<li>Windows UI Programming

<ul>
<li>TODO</li>
</ul>
</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="c1">// monitor</span>
</span><span class='line'><span class="k">using</span> <span class="n">System</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="n">System</span><span class="p">.</span><span class="n">Threading</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="n">System</span><span class="p">.</span><span class="n">Threading</span><span class="p">.</span><span class="n">Tasks</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Program</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">// Note that calls to Monitor.Enter() and Monitor.Exit() are associated </span>
</span><span class='line'>  <span class="c1">// with each other by sharing the same object reference passed as the </span>
</span><span class='line'>  <span class="c1">// parameter (in this case _Sync).</span>
</span><span class='line'>  <span class="n">readonly</span> <span class="k">static</span> <span class="n">object</span> <span class="n">_Sync</span> <span class="o">=</span> <span class="k">new</span> <span class="n">object</span><span class="p">();</span>
</span><span class='line'>  <span class="k">const</span> <span class="kt">int</span> <span class="n">_Total</span> <span class="o">=</span> <span class="kt">int</span><span class="p">.</span><span class="n">MaxValue</span><span class="p">;</span>
</span><span class='line'>  <span class="k">static</span> <span class="kt">long</span> <span class="n">_Count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="k">static</span> <span class="kt">void</span> <span class="n">Main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">Task</span> <span class="n">task</span> <span class="o">=</span> <span class="n">Task</span><span class="p">.</span><span class="n">Factory</span><span class="p">.</span><span class="n">StartNew</span><span class="p">(</span><span class="n">Decrement</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Increment</span>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">_Total</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="kt">bool</span> <span class="n">lockTaken</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'>      <span class="n">Monitor</span><span class="p">.</span><span class="n">Enter</span><span class="p">(</span><span class="n">_Sync</span><span class="p">,</span> <span class="n">ref</span> <span class="n">lockTaken</span><span class="p">);</span>
</span><span class='line'>      <span class="k">try</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">_Count</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span> <span class="n">finally</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">lockTaken</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="n">Monitor</span><span class="p">.</span><span class="n">Exit</span><span class="p">(</span><span class="n">_Sync</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">task</span><span class="p">.</span><span class="n">Wait</span><span class="p">();</span>
</span><span class='line'>    <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;Count = {0}&quot;</span><span class="p">,</span> <span class="n">_Count</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">static</span> <span class="kt">void</span> <span class="n">Decrement</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">_Total</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="kt">bool</span> <span class="n">lockTaken</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'>      <span class="n">Monitor</span><span class="p">.</span><span class="n">Enter</span><span class="p">(</span><span class="n">_Sync</span><span class="p">,</span> <span class="n">ref</span> <span class="n">lockTaken</span><span class="p">);</span>
</span><span class='line'>      <span class="k">try</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">_Count</span><span class="o">--</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span> <span class="n">finally</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">lockTaken</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="n">Monitor</span><span class="p">.</span><span class="n">Exit</span><span class="p">(</span><span class="n">_Sync</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="c1">// lock</span>
</span><span class='line'><span class="k">using</span> <span class="n">System</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="n">System</span><span class="p">.</span><span class="n">Threading</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="n">System</span><span class="p">.</span><span class="n">Threading</span><span class="p">.</span><span class="n">Tasks</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Program</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">readonly</span> <span class="k">static</span> <span class="n">object</span> <span class="n">_Sync</span> <span class="o">=</span> <span class="k">new</span> <span class="n">object</span><span class="p">();</span>
</span><span class='line'>  <span class="k">const</span> <span class="kt">int</span> <span class="n">_Total</span> <span class="o">=</span> <span class="kt">int</span><span class="p">.</span><span class="n">MaxValue</span><span class="p">;</span>
</span><span class='line'>  <span class="k">static</span> <span class="kt">long</span> <span class="n">_Count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="k">static</span> <span class="kt">void</span> <span class="n">Main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">Task</span> <span class="n">task</span> <span class="o">=</span> <span class="n">Task</span><span class="p">.</span><span class="n">Factory</span><span class="p">.</span><span class="n">StartNew</span><span class="p">(</span><span class="n">Decrement</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Increment</span>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">_Total</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">lock</span> <span class="p">(</span><span class="n">_Sync</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">_Count</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">task</span><span class="p">.</span><span class="n">Wait</span><span class="p">();</span>
</span><span class='line'>    <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;Count = {0}&quot;</span><span class="p">,</span> <span class="n">_Count</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">static</span> <span class="kt">void</span> <span class="n">Decrement</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">_Total</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">lock</span> <span class="p">(</span><span class="n">_Sync</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">_Count</span><span class="o">--</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="c1">// mutex</span>
</span><span class='line'><span class="c1">// It cannot run correctly on Ubuntu with mono.</span>
</span><span class='line'><span class="k">using</span> <span class="n">System</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="n">System</span><span class="p">.</span><span class="n">Threading</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="n">System</span><span class="p">.</span><span class="n">Reflection</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Program</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">static</span> <span class="kt">void</span> <span class="n">Main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// Indicates whether this is the first</span>
</span><span class='line'>    <span class="c1">// application instance</span>
</span><span class='line'>    <span class="kt">bool</span> <span class="n">firstApplicationInstance</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Obtain the mutex name from the full</span>
</span><span class='line'>    <span class="c1">// assembly name.</span>
</span><span class='line'>    <span class="n">string</span> <span class="n">mutexName</span> <span class="o">=</span> <span class="n">Assembly</span><span class="p">.</span><span class="n">GetEntryAssembly</span><span class="p">().</span><span class="n">FullName</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">using</span> <span class="p">(</span><span class="n">Mutex</span> <span class="n">mutex</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Mutex</span><span class="p">(</span><span class="kc">false</span><span class="p">,</span> <span class="n">mutexName</span><span class="p">,</span> <span class="n">out</span> <span class="n">firstApplicationInstance</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">firstApplicationInstance</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">Console</span><span class="p">.</span><span class="n">Write</span><span class="p">(</span><span class="s">&quot;This application is already running.&quot;</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;ENTER to shut down&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="n">Console</span><span class="p">.</span><span class="n">ReadLine</span><span class="p">();</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="c1">// APM </span>
</span><span class='line'><span class="k">using</span> <span class="n">System</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="n">System</span><span class="p">.</span><span class="n">IO</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="n">System</span><span class="p">.</span><span class="n">Net</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="n">System</span><span class="p">.</span><span class="n">Linq</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">Program</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">static</span> <span class="kt">void</span> <span class="n">Main</span><span class="p">(</span><span class="n">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">string</span> <span class="n">url</span> <span class="o">=</span> <span class="s">&quot;http://www.puncsky.com&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">Length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">url</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">url</span><span class="p">);</span>
</span><span class='line'>    <span class="n">WebRequest</span> <span class="n">webRequest</span> <span class="o">=</span> <span class="n">WebRequest</span><span class="p">.</span><span class="n">Create</span><span class="p">(</span><span class="n">url</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// puncsky: `BeginX` method call</span>
</span><span class='line'>    <span class="n">IAsyncResult</span> <span class="n">asyncResult</span> <span class="o">=</span> <span class="n">webRequest</span><span class="p">.</span><span class="n">BeginGetResponse</span><span class="p">(</span><span class="n">null</span><span class="p">,</span> <span class="n">null</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">asyncResult</span><span class="p">.</span><span class="n">AsyncWaitHandle</span><span class="p">.</span><span class="n">WaitOne</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">Console</span><span class="p">.</span><span class="n">Write</span><span class="p">(</span><span class="sc">&#39;.&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// puncsky: `EndX` method call</span>
</span><span class='line'>    <span class="c1">// Retrieve the results when finished</span>
</span><span class='line'>    <span class="c1">// downloading</span>
</span><span class='line'>    <span class="n">WebResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="n">webRequest</span><span class="p">.</span><span class="n">EndGetResponse</span><span class="p">(</span><span class="n">asyncResult</span><span class="p">);</span>
</span><span class='line'>    <span class="k">using</span> <span class="p">(</span><span class="n">StreamReader</span> <span class="n">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StreamReader</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">GetResponseStream</span><span class="p">()))</span> <span class="p">{</span>
</span><span class='line'>      <span class="kt">int</span> <span class="n">length</span> <span class="o">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">ReadToEnd</span><span class="p">().</span><span class="n">Length</span><span class="p">;</span>
</span><span class='line'>      <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">FormatBytes</span><span class="p">(</span><span class="n">length</span><span class="p">));</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">static</span> <span class="k">public</span> <span class="n">string</span> <span class="n">FormatBytes</span><span class="p">(</span><span class="kt">long</span> <span class="n">bytes</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">string</span><span class="p">[]</span> <span class="n">magnitudes</span> <span class="o">=</span> <span class="k">new</span> <span class="n">string</span><span class="p">[]</span> <span class="p">{</span> <span class="s">&quot;GB&quot;</span><span class="p">,</span> <span class="s">&quot;MB&quot;</span><span class="p">,</span> <span class="s">&quot;KB&quot;</span><span class="p">,</span> <span class="s">&quot;Bytes&quot;</span> <span class="p">};</span>
</span><span class='line'>    <span class="kt">long</span> <span class="n">max</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">Math</span><span class="p">.</span><span class="n">Pow</span><span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="n">magnitudes</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">string</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="s">&quot;{1:##.##} {0}&quot;</span><span class="p">,</span> <span class="n">magnitudes</span><span class="p">.</span><span class="n">FirstOrDefault</span><span class="p">(</span>
</span><span class='line'>        <span class="n">magnitude</span> <span class="o">=&gt;</span> <span class="n">bytes</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">max</span> <span class="o">/=</span> <span class="mi">1024</span><span class="p">))</span><span class="o">??</span> <span class="s">&quot;0 Bytes&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">decimal</span><span class="p">)</span><span class="n">bytes</span> <span class="o">/</span> <span class="p">(</span><span class="n">decimal</span><span class="p">)</span><span class="n">max</span><span class="p">).</span><span class="n">Trim</span><span class="p">();</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>20 Platform Interoperability and Unsafe Code 815</h2>

<ul>
<li>What if the memory addresses and pointers have be used?</li>
<li>3 ways

<ul>
<li>Platform Invoke (P/Invoke)</li>
<li><strong>unsafe code</strong></li>
<li><strong>COM</strong></li>
</ul>
</li>
</ul>


<h2>21 The Common Language Infrastructure 843</h2>

<ul>
<li>TODO</li>
</ul>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Tian</span></span>

      








  


<time datetime="2013-09-15T13:58:00-07:00" pubdate data-updated="true">Sep 15<span>th</span>, 2013</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/programming-language/'>programming_language</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://www.puncsky.com/blog/2013/09/15/essential-c-sharp-advanced/" data-via="" data-counturl="http://www.puncsky.com/blog/2013/09/15/essential-c-sharp-advanced/" >Tweet</a>
  
  
  
</div>

    
    
    <section>
      <h1>Comments</h1>
      <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
    </section>
    
    <ul class="pager">
      
      <li class="previous"><a class="basic-alignment left"
        href="/blog/2013/09/14/h-quincy/" title="Previous Post:
        H-Quincy: Fair Scheduling for Hadoop Clusters">&laquo; H-Quincy: Fair Scheduling for Hadoop Clusters</a></li>
      
      <li><a href="/blog/archives">Blog Archives</a></li>
      
      <li class="next"><a class="basic-alignment right" href="/blog/2013/09/23/scaling-memcache-at-facebook/"
        title="Next Post: Call-of-Duty Weekend Reading: Scaling Memcache at Facebook (NSDI '13)">Call-of-Duty Weekend Reading: Scaling Memcache at Facebook (NSDI '13)
        &raquo;</a></li>
      
    </ul>
  </footer>
</article>

<aside class="sidebar-nav span3">
  
    <section class="well">
  <script src="/javascripts/onmouseoverpuncsky.js" type="text/javascript"> </script>
  <img onmouseover="enlight(this)" onmouseout="darken(this)" src="/puncsky-gray.png" alt="puncsky" style="max-width:100%;">
  <h4>Puncsky</h4>
  <p><i>He who strives on and lives to strive can earn redemption still.</i></p>
  <p><a href="https://www.github.com/puncsky/">Github</a></p>
</section>
<section class="well">
  <ul id="recent_posts" class="nav nav-list">
    <li class="nav-header">Recent Posts</li>
    
      <li class="post">
        <a href="/blog/2016/02/14/crack-the-system-design-interview/">Crack the System Design Interview</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/12/22/da-xue-de-ling-hun-yu-wei-du/">大学的灵魂与维度</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/05/06/suffering-oriented-programming/">面向痛苦编程 (译文)</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/02/04/callbacks-as-our-generations-goto/">Miguel de Icaza: Callbacks 就像我们这一代人的 Go To 语句</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/01/13/understanding-reactor-pattern-for-highly-scalable-i-o-bound-web-server/">Understanding Reactor Pattern for Highly Scalable I/O Bound Web Server</a>
      </li>
    
  </ul>
</section>
<section class="well">
	<div id="clustrmaps-widget"></div><script type="text/javascript">var _clustrmaps = {'url' : 'http://www.puncsky.com', 'user' : 1100959, 'server' : '2', 'id' : 'clustrmaps-widget', 'version' : 1, 'date' : '2013-06-24', 'lang' : 'en', 'corners' : 'square' };(function (){ var s = document.createElement('script'); s.type = 'text/javascript'; s.async = true; s.src = 'http://www2.clustrmaps.com/counter/map.js'; var x = document.getElementsByTagName('script')[0]; x.parentNode.insertBefore(s, x);})();</script><noscript><a href="http://www2.clustrmaps.com/user/92810cc9f"><img src="http://www2.clustrmaps.com/stats/maps-no_clusters/www.puncsky.com-thumb.jpg" alt="Locations of visitors to this page" /></a></noscript>
</section>






  
</aside>


    </div>
  </div>
  <footer role="contentinfo" class="page-footer"><hr>
<p>
  Copyright &copy; 2016 - Tian -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'puncsky';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://www.puncsky.com/blog/2013/09/15/essential-c-sharp-advanced/';
        var disqus_url = 'http://www.puncsky.com/blog/2013/09/15/essential-c-sharp-advanced/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
